name: D1 Database Manager

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Database action to perform'
        required: true
        type: choice
        options:
          - list
          - query
          - backup
          - restore
      database_name:
        description: 'Database name (from projects.json)'
        required: false
        type: string
      query:
        description: 'SQL query to execute'
        required: false
        type: string

jobs:
  manage-database:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Authenticate with Cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Authenticated with Cloudflare account"

      - name: Execute Database Action
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          case "${{ inputs.action }}" in
            list)
              echo "Listing all D1 databases..."
              wrangler d1 list
              ;;
            query)
              if [ -z "${{ inputs.database_name }}" ] || [ -z "${{ inputs.query }}" ]; then
                echo "Error: database_name and query are required for query action"
                exit 1
              fi
              echo "Executing query on ${{ inputs.database_name }}..."
              wrangler d1 execute ${{ inputs.database_name }} --command="${{ inputs.query }}"
              ;;
            backup)
              if [ -z "${{ inputs.database_name }}" ]; then
                echo "Error: database_name is required for backup action"
                exit 1
              fi
              echo "Creating backup of ${{ inputs.database_name }}..."
              wrangler d1 export ${{ inputs.database_name }} --output=backup-$(date +%Y%m%d-%H%M%S).sql
              ;;
            restore)
              echo "Restore functionality - implement as needed"
              ;;
          esac

      - name: Upload backup artifact
        if: inputs.action == 'backup'
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ inputs.database_name }}-${{ github.run_number }}
          path: '*.sql'
          retention-days: 30
