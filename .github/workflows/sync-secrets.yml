name: Sync Secrets Across Ecosystem

on:
  workflow_dispatch:
    inputs:
      target_repos:
        description: 'Comma-separated list of repos to sync (or "all" for all projects)'
        required: true
        default: 'all'
        type: string
      secrets_to_sync:
        description: 'Comma-separated list of secret names to sync'
        required: true
        default: 'CLOUDFLARE_API_TOKEN,CLOUDFLARE_ACCOUNT_ID,VERCEL_TOKEN'
        type: string

jobs:
  sync-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Parse projects.json
        id: parse-projects
        run: |
          if [ "${{ inputs.target_repos }}" = "all" ]; then
            REPOS=$(jq -r '.projects[].repository' projects.json | tr '\n' ',')
          else
            REPOS="${{ inputs.target_repos }}"
          fi
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "Will sync to repositories: $REPOS"

      - name: Sync secrets to target repositories
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          IFS=',' read -ra REPO_ARRAY <<< "${{ steps.parse-projects.outputs.repos }}"
          IFS=',' read -ra SECRET_ARRAY <<< "${{ inputs.secrets_to_sync }}"
          
          for repo in "${REPO_ARRAY[@]}"; do
            repo=$(echo $repo | xargs)  # trim whitespace
            if [ -z "$repo" ]; then continue; fi
            
            echo "Syncing secrets to $repo..."
            
            for secret_name in "${SECRET_ARRAY[@]}"; do
              secret_name=$(echo $secret_name | xargs)  # trim whitespace
              if [ -z "$secret_name" ]; then continue; fi
              
              # Get the secret value from environment
              secret_value="${!secret_name}"
              
              if [ -z "$secret_value" ]; then
                echo "Warning: Secret $secret_name not found in environment, skipping..."
                continue
              fi
              
              echo "Syncing $secret_name to $repo..."
              
              # Use GitHub CLI to set repository secret
              echo "$secret_value" | gh secret set "$secret_name" \
                --repo "$repo" \
                --app actions \
                --body -
              
              if [ $? -eq 0 ]; then
                echo "✓ Successfully synced $secret_name to $repo"
              else
                echo "✗ Failed to sync $secret_name to $repo"
              fi
            done
            
            echo "Completed syncing to $repo"
            echo "---"
          done
          
          echo "Secret sync completed!"

      - name: Summary
        run: |
          echo "### Secret Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target Repositories:** ${{ steps.parse-projects.outputs.repos }}" >> $GITHUB_STEP_SUMMARY
          echo "**Secrets Synced:** ${{ inputs.secrets_to_sync }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for detailed sync status." >> $GITHUB_STEP_SUMMARY
